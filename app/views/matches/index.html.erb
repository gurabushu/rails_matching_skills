<div class="matches-container" data-controller="tabs">
  <div class="page-header">
    <h1>マッチング管理</h1>
    <div class="nav-links">
      <%= link_to "← スキル一覧", root_path, class: "btn btn-secondary" %>
      <%= link_to "チャット", chat_rooms_path, class: "btn btn-outline" %>
      <%= link_to "スキル交換", deals_path, class: "btn btn-outline" %>
    </div>
  </div>
  
  <!-- タブメニュー -->
  <div class="match-tabs">
    <button class="tab-btn active" data-tab="matched" data-action="click->tabs#switch">マッチ済み</button>
    <button class="tab-btn" data-tab="received" data-action="click->tabs#switch">受信済み</button>
    <button class="tab-btn" data-tab="sent" data-action="click->tabs#switch">送信済み</button>
  </div>
  
  <!-- マッチ済みユーザー -->
  <div class="tab-content active" id="matched-tab">
    <div class="tab-header">
      <h2>💕 マッチしたユーザー (<%= @matched_users.count %>)</h2>
      <div class="quick-nav">
        <%= link_to "チャット一覧", chat_rooms_path, class: "btn btn-outline btn-sm" %>
        <%= link_to "取引一覧", deals_path, class: "btn btn-outline btn-sm" %>
      </div>
    </div>
    <% if @matched_users.any? %>
      <div class="matches-grid">
        <% @matched_users.each do |user| %>
          <% 
            # そのユーザーとのマッチを見つける
            user_match = @sent_matches.find { |m| m.target_user == user && m.status == 1 } ||
                        @received_matches.find { |m| m.user == user && m.status == 1 }
          %>
          <div class="match-card matched">
            <h3><%= user.name %></h3>
            <p><strong>スキル:</strong> <%= user.skill %></p>
            <% if user.description.present? %>
              <p class="description"><%= truncate(user.description, length: 80) %></p>
            <% end %>
            <div class="match-info">
              <span class="match-status">✨ マッチ成立</span>
            </div>
            <% if user_match %>
              <% chat_room = user_match.chat_room || user_match.create_chat_room! %>
              <div class="match-actions">
                <%= link_to "チャット", chat_room_path(chat_room), class: "btn btn-primary btn-sm" %>
                <%= link_to "スキル交換提案", new_match_deal_path(user_match), class: "btn btn-success btn-sm" %>
              </div>
            <% else %>
              <div class="match-actions">
                <span class="text-muted">マッチ情報が見つかりません</span>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="no-matches">まだマッチしたユーザーはいません。</p>
    <% end %>
  </div>
  
  <!-- 受信したマッチリクエスト -->
  <div class="tab-content" id="received-tab">
    <h2>💌 受信したいいね (<%= @received_matches.where(status: 0).count %>)</h2>
    <% received_pending = @received_matches.where(status: 0).includes(:user) %>
    <% if received_pending.any? %>
      <div class="matches-grid">
        <% received_pending.each do |match| %>
          <div class="match-card received">
            <h3><%= match.user.name %></h3>
            <p><strong>スキル:</strong> <%= match.user.skill %></p>
            <% if match.user.description.present? %>
              <p class="description"><%= truncate(match.user.description, length: 80) %></p>
            <% end %>
            <div class="match-actions">
              <%= button_to "承認", accept_match_path(match), 
                          method: :patch, 
                          class: "btn btn-success btn-sm" %>
              <%= button_to "拒否", reject_match_path(match), 
                          method: :patch, 
                          class: "btn btn-outline-danger btn-sm",
                          data: { confirm: "本当に拒否しますか？" } %>
            </div>
            <div class="match-info">
              <small>受信日: <%= match.created_at.strftime("%m/%d %H:%M") %></small>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="no-matches">新しいいいねはありません。</p>
    <% end %>
  </div>
  
  <!-- 送信したマッチリクエスト -->
  <div class="tab-content" id="sent-tab">
    <h2>📤 送信したいいね (<%= @sent_matches.where(status: 0).count %>)</h2>
    <% sent_pending = @sent_matches.where(status: 0).includes(:target_user) %>
    <% if sent_pending.any? %>
      <div class="matches-grid">
        <% sent_pending.each do |match| %>
          <div class="match-card sent">
            <h3><%= match.target_user.name %></h3>
            <p><strong>スキル:</strong> <%= match.target_user.skill %></p>
            <% if match.target_user.description.present? %>
              <p class="description"><%= truncate(match.target_user.description, length: 80) %></p>
            <% end %>
            <div class="match-actions">
              <%= button_to "取り消す", destroy_match_path(match.target_user), 
                          method: :delete, 
                          class: "btn btn-outline-secondary btn-sm",
                          data: { confirm: "いいねを取り消しますか？" } %>
            </div>
            <div class="match-info">
              <small>送信日: <%= match.created_at.strftime("%m/%d %H:%M") %></small>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="no-matches">送信中のいいねはありません。</p>
    <% end %>
  </div>
</div>
